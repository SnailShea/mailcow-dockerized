rules {
	RLINFO {
		backend = "http";
		url = "http://nginx:9081/pipe_rl.php";
		selector = "ratelimited";
		formatter = "json";
	}
  PUSHOVERMAIL {
    backend = "http";
    url = "http://nginx:9081/pushover.php";
    selector = "mailcow_rcpt";
    formatter = "json";
    meta_headers = true;
  }
  QUARANTINE {
    backend = "http";
    url = "http://localhost/pipe.php";
    selector = "quarantine";
    formatter = "json";
  }
}

custom_select {
  quarantine = <<EOD
return function(task)
  local logger = require "rspamd_logger"
  local action = task:get_metric_action('default')
  local from = task:get_header('From')
  if action == 'quarantine' then
    logger.infox(rspamd_config, "Quarantined mail from %s", from)
  end
end
EOD
  mailcow_rcpt = <<EOD
return function(task)
  local action = task:get_metric_action('default')
  if task:has_symbol('NO_LOG_STAT') or (action == 'soft reject' or action == 'reject' or action == 'add header' or action == 'rewrite subject') then
    return false
  else
    if task:get_symbol("RCPT_MAILCOW_DOMAIN") then
      return true
    end
    return false
  end
end
EOD;
  ratelimited = <<EOD
return function(task)
  local ratelimited = task:get_symbol("RATELIMITED")
  if ratelimited then
    return true
  end
  return false
end
EOD;
}

custom_format {
  msgid = <<EOD
return function(task)
  return task:get_message_id()
end
EOD;
}

